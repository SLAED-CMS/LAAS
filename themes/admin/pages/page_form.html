{% extends "layout.html" %}

{% block head_extra %}
  <link href="{% assets.toastui_editor_css %}" rel="stylesheet">
{% endblock %}

{% block scripts_extra %}
  <script src="{% assets.tinymce_js %}" defer></script>
  <script src="{% assets.toastui_editor_js %}" defer></script>
  <script src="{% assets.pages_admin_editors_js %}" defer></script>
{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header">
        <strong>
          {% if is_edit %}
          {% t 'admin.pages.edit' %}
          {% else %}
          {% t 'admin.pages.new' %}
          {% endif %}
        </strong>
      </div>
      <div class="card-body">
        <div id="page-messages">
          {% include "partials/form_errors.html" %}
        </div>
        <form method="post"
              action="/admin/pages/save"
              hx-post="/admin/pages/save"
              hx-target="#page-messages"
              hx-swap="innerHTML"
              hx-indicator="#loading"
              data-slug-form="1"
              data-page-form="1"
              data-mode="{% mode %}">
          <input type="hidden" name="_token" value="{% csrf_token %}">
          {% if is_edit %}
          <input type="hidden" name="id" value="{% page.id %}">
          {% endif %}
          <div class="mb-3">
            <label class="form-label">{% t 'admin.pages.form.title' %}</label>
            <input class="form-control" id="page-title" name="title" value="{% page.title %}" maxlength="255" required>
          </div>
          <div class="mb-3">
            <label class="form-label">{% t 'admin.pages.form.slug' %}</label>
            <input class="form-control" id="page-slug" name="slug" value="{% page.slug %}" maxlength="255" required>
            <div class="form-text">{% t 'admin.pages.form.slug_help' %}</div>
          </div>
          <div class="mb-3">
            <label class="form-label">{% t 'admin.pages.form.status' %}</label>
            <select class="form-select" name="status">
              <option value="draft" {% raw status_selected_draft %}>{% t 'admin.pages.status.draft' %}</option>
              <option value="published" {% raw status_selected_published %}>{% t 'admin.pages.status.published' %}</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Editor</label>
            <div class="btn-group" role="group" aria-label="Content editor">
              <input class="btn-check" type="radio" name="content_format_ui" id="content-format-html"
                     value="html" data-editor-choice="1" autocomplete="off"
                     {% if page.content_format == 'markdown' %}{% else %}checked{% endif %}>
              <label class="btn btn-outline-secondary btn-sm" for="content-format-html">HTML (TinyMCE)</label>
              <input class="btn-check" type="radio" name="content_format_ui" id="content-format-markdown"
                     value="markdown" data-editor-choice="1" autocomplete="off"
                     {% if page.content_format == 'markdown' %}checked{% endif %}>
              <label class="btn btn-outline-secondary btn-sm" for="content-format-markdown">Markdown (Toast UI)</label>
            </div>
            <input type="hidden" name="content_format" value="{% if page.content_format == 'markdown' %}markdown{% else %}html{% endif %}" data-content-format="1">
          </div>
          <div class="mb-3">
            <label class="form-label">
              {% t 'admin.pages.form.content' %}
              {% if legacy_content %}
              <span class="badge text-bg-warning ms-2">{% t 'admin.pages.legacy_content' %}</span>
              {% endif %}
            </label>
            <textarea class="form-control" id="page-content" name="content" rows="10">{% page.content %}</textarea>
            <div class="border rounded bg-white p-2 d-none" data-markdown-editor="1"></div>
            {% if legacy_content %}
            <div class="form-text text-warning">{% t 'admin.pages.legacy_content_hint' %}</div>
            {% endif %}
          </div>
          {% if blocks_json_allowed %}
          {% if admin_features.blocks_studio %}
          <div class="card mb-3" data-blocks-studio="1" data-target-textarea="#blocks-json">
            <div class="card-header d-flex align-items-center justify-content-between">
              <strong>Blocks Studio (MVP)</strong>
              <span class="badge text-bg-secondary">JSON source</span>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                <select class="form-select form-select-sm w-auto" data-blocks-studio-type="1">
                  {% foreach blocks_registry_types as type %}
                  <option value="{% type %}">{% type %}</option>
                  {% endforeach %}
                </select>
                <button class="btn btn-sm btn-outline-primary" type="button" data-blocks-studio-add="1">Add block</button>
                <span class="text-muted small">Edit JSON anytime. Studio stays in sync.</span>
              </div>
              <div class="text-muted small mb-2 d-none" data-blocks-studio-error="1"></div>
              <div class="d-flex flex-column gap-2" data-blocks-studio-list="1"></div>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-header">
              <button class="btn btn-link p-0 text-decoration-none" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#page-blocks-json"
                      aria-expanded="false"
                      aria-controls="page-blocks-json">
                Blocks (JSON)
              </button>
            </div>
            <div class="collapse" id="page-blocks-json">
              <div class="card-body">
                <textarea class="form-control font-monospace" id="blocks-json" name="blocks_json" rows="10" spellcheck="false">{% page.blocks_json %}</textarea>
              </div>
            </div>
          </div>
          {% endif %}
          {% endif %}
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-primary" type="submit">{% t 'admin.pages.form.save' %}</button>
            {% if blocks_json_allowed %}
            {% if admin_features.blocks_studio %}
            <button class="btn btn-outline-secondary" type="button"
                    data-preview-blocks="1"
                    data-preview-action="/admin/pages/preview-blocks"
                    data-preview-target="_blank">
              Preview blocks
            </button>
            {% endif %}
            {% endif %}
            <a class="btn btn-outline-secondary disabled" id="page-preview" href="#" target="_blank" rel="noopener" aria-disabled="true" tabindex="-1">{% t 'admin.pages.form.preview' %}</a>
          </div>
        </form>
        <div id="loading" class="htmx-indicator text-center my-3">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm border-primary" data-ai-assist="1">
      <div class="card-header d-flex align-items-center justify-content-between bg-primary bg-opacity-10">
        <strong>AI Assist</strong>
        <span class="badge text-bg-secondary">Read-only</span>
      </div>
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 mb-2">
          <span class="badge text-bg-success">Read-only</span>
          <span class="badge text-bg-info">Dry-run</span>
          <span class="badge text-bg-warning">CLI apply only</span>
        </div>
        <div class="mt-2 d-flex align-items-center gap-2 flex-wrap">
          <span class="badge text-bg-primary">1) Propose</span>
          <span class="text-muted small">→</span>
          <span class="badge text-bg-secondary">2) Dry-run</span>
          <span class="text-muted small">→</span>
          <span class="badge text-bg-secondary">3) Save</span>
          <span class="text-muted small">→</span>
          <span class="badge text-bg-dark">4) CLI Apply (--yes)</span>
        </div>
        <div class="text-muted small mt-2">Review diff and checks. UI never applies changes.</div>
        <div class="text-muted small mb-2">Focused field: <span id="ai-field-label">none</span></div>
        <div id="ai-assist-fields">
          <input type="hidden" id="ai_field" name="context[field]">
          <input type="hidden" id="ai_page_id" name="context[page_id]" value="{% if is_edit %}{% page.id %}{% endif %}">
          <input type="hidden" id="ai_url" name="context[url]">
          <textarea class="d-none" id="ai_value" name="context[value]"></textarea>
          <label class="form-label small" for="ai_prompt">Prompt</label>
          <textarea class="form-control form-control-sm" id="ai_prompt" name="prompt" rows="4"
                    placeholder="Describe what to improve..."></textarea>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <button type="button"
                  class="btn btn-primary btn-sm"
                  hx-post="/api/v1/ai/propose"
                  hx-target="#ai-propose-out"
                  hx-swap="innerHTML"
                  hx-include="#ai-assist-fields">
            Propose (Preview)
          </button>
          <button type="button"
                  class="btn btn-outline-secondary btn-sm"
                  hx-post="/api/v1/ai/run"
                  hx-target="#ai-run-out"
                  hx-swap="innerHTML"
                  hx-include="#plan_json">
            Run Dry-Run
          </button>
          <button type="button"
                  class="btn btn-outline-success btn-sm"
                  hx-post="/admin/ai/save-proposal"
                  hx-target="#ai-save-out"
                  hx-swap="innerHTML"
                  hx-include="#proposal_json">
            Save Proposal
          </button>
        </div>
        <div class="small text-muted mt-2">
          <div>Propose drafts a plan without writing files.</div>
          <div>Dry-run executes allowlisted checks only.</div>
          <div>Save stores a proposal for CLI apply.</div>
        </div>
        <div id="ai-propose-out" class="mt-3 p-2 bg-light border rounded small"></div>
        <div id="ai-run-out" class="mt-2 p-2 bg-light border rounded small"></div>
        <div id="ai-save-out" class="mt-2 p-2 bg-light border rounded small"></div>
        <div class="alert alert-warning mt-3 mb-0 small">
          Apply requires CLI with <code>--yes</code>.
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
