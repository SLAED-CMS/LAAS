<div class="laas-devtools position-fixed bottom-0 start-0 end-0 border-top z-3" id="devtools-root">
  <style>
  .laas-devtools.devtools-hidden { display: none; }
  .laas-devtools {
    --dt-bg: #282c34;
    --dt-fg: #abb2bf;
    --dt-muted: #636d83;
    --dt-info: #10b1fe;
    --dt-ok: #3fc56b;
    --dt-warn: #f9c859;
    --dt-num: #ff78f8;
    background: var(--dt-bg);
    color: var(--dt-fg);
    font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
    font-size: 16px;
    line-height: 1.4;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .laas-devtools .text-muted,
  .laas-devtools .text-secondary { color: var(--dt-muted) !important; }
  .laas-devtools .info { color: var(--dt-info); }
  .laas-devtools :where(.ok) { color: var(--dt-ok); }
  .laas-devtools :where(.warn) { color: var(--dt-warn); }
  .laas-devtools .num { color: var(--dt-num); }
  .laas-devtools .devtools-terminal { background: transparent; }
  .laas-devtools .terminal-body { max-height: 50vh; overflow: auto; }
  .laas-devtools .devtools-terminal pre { white-space: pre-wrap; margin: 0; }
</style>
  <div class="devtools-terminal collapse show rounded-3 p-2" id="devtools-terminal">
    <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
      <span class="me-auto"> <span class="info">SQL:</span> <span class="num">{% devtools.profile.terminal.prompt.sql_raw %}/{% devtools.profile.terminal.prompt.sql_unique %}</span> <span class="text-muted">|</span> <span class="info">Dup:</span> <span class="num">{% devtools.profile.terminal.prompt.sql_dup %}</span> <span class="text-muted">|</span> <span class="num">{% devtools.profile.terminal.prompt.sql_ms %}ms</span> <span class="info">Time:</span> <span class="num">{% devtools.profile.terminal.prompt.total_ms %}ms</span> <span class="info">Memory:</span> <span class="num">{% devtools.profile.terminal.prompt.memory_mb %}MB</span> <span class="info">Cache:</span> <span class="num">{% devtools.profile.terminal.prompt.cache_rate %}</span> <span class="info">HTTP</span> <span class="num">{% devtools.profile.terminal.prompt.http_count %} ({% devtools.profile.terminal.prompt.http_max_ms %}ms)</span> <span>{% devtools.profile.terminal.prompt.method %}:</span> <span class="text-muted">{% devtools.profile.terminal.prompt.path %}</span>{% if devtools.profile.terminal.prompt.post_params %} <span class="text-muted">POST:</span> <span class="warn">{% devtools.profile.terminal.prompt.post_params|implode:', ' %}</span>{% endif %} <span class="info">Status:</span> <span>{% devtools.profile.terminal.prompt.status %}</span> <span class="text-muted">Req ID:</span> <span class="text-muted">{% devtools.profile.terminal.prompt.request_id %}</span></span>
      <a href="" class="btn btn-sm devtools-btn" title="Refresh">&#x27F3;</a>
      <button class="btn btn-sm devtools-btn" type="button" data-devtools-action="copy" title="Copy">&#x29C9;</button>
      <button class="btn btn-sm devtools-btn" type="button" data-devtools-action="expand" title="Expand all">&#x2912;</button>
      <button class="btn btn-sm devtools-btn" type="button" data-bs-toggle="collapse" data-bs-target="#devtools-details" aria-controls="devtools-details" title="Toggle Details">&#x2139;</button>
      <button class="btn btn-sm devtools-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#devtools-settings" aria-controls="devtools-settings" title="Settings">&#x2699;</button>
      <button class="btn btn-sm devtools-btn" type="button" data-bs-toggle="collapse" data-bs-target="#devtools-terminal" title="Hide">&#x2715;</button>
    </div>
    <div class="terminal-body overflow-auto" id="devtools-terminal-body">
<pre id="devtools-terminal-dump" class="mb-2">
{% if devtools.profile.terminal.warning_tokens %}

<span class="warn">&#x26A0; Warnings</span>
{% foreach devtools.profile.terminal.warning_tokens as tok %}<span>{% tok.text %}</span>
{% endforeach %}
{% else %}<span class="ok">&#x2713; No warnings</span>{% endif %}{% if devtools.profile.terminal.offenders %}

{% foreach devtools.profile.terminal.offenders as off %}<a class="text-decoration-none" data-bs-toggle="collapse" href="#{% off.id %}" role="button" aria-expanded="false" aria-controls="{% off.id %}"><span class="info">{% off.type %}</span> {% if off.is_http %}<span>{% off.detail_method %}</span> <span class="text-muted">{% off.detail_url %}</span>{% else %}<span>{% off.detail_text %}</span>{% endif %} <span class="num">{% off.value %}</span></a>
{% endforeach %}{% else %}<span class="text-muted">No offenders</span>{% endif %}
{% if devtools.profile.terminal.timeline_line %}
<span class="text-muted">{% devtools.profile.timeline_line %}</span>{% endif %}
</pre>
    {% foreach devtools.profile.terminal.offenders as off %}
    <div class="collapse devtools-detail small text-secondary mb-1" id="{% off.id %}">
      {% if off.is_http %}
      <div>HTTP: <span>{% off.detail_method %}</span> <span class="text-muted">{% off.detail_url %}</span> (<span>{% off.detail.status %}</span>, <span class="num">{% off.detail.total_ms %}</span> ms)</div>
      {% endif %}
      {% if off.is_sqld %}
      <div>SQLD: {% off.detail.count %} calls (avg <span class="num">{% off.detail.avg_ms %}</span> ms)</div>
      <div><code class="small text-break">{% off.detail.sql %}</code></div>
      {% if off.detail.trace %}
      <ol class="mb-0">
        {% foreach off.detail.trace as t %}
        <li><code>{% t.call %}</code> <span class="text-muted">{% t.file %}</span></li>
        {% endforeach %}
      </ol>
      {% endif %}
      {% endif %}
      {% if off.is_sql %}
      <div>SQL: <span class="num">{% off.detail.total_ms %}</span> ms</div>
      <div><code class="small text-break">{% off.detail.sql %}</code></div>
      {% endif %}
    </div>
    {% endforeach %}
      <div id="devtools-details" class="collapse devtools-detail terminal-details" data-devtools-collapse="1" data-devtools-id="details">
        <div class="small">
          <div class="mb-2" id="devtools-js-errors">
            <span class="info">JS Errors</span>

            <div id="devtools-js-errors-content">
              {% if devtools.js_errors %}
              <div class="small text-muted">
              {% foreach devtools.js_errors as err %}[{% err.time_ago %}] {% if err.is_error %}ERROR{% else %}PROMISE{% endif %}: {% err.message %}
              {% endforeach %}</div>
              {% else %}
              <div class="small text-muted">No JS errors</div>
              {% endif %}
            </div>



          <div class="mb-2" id="devtools-overview">
            <span class="info">Overview</span>
            <div class="text-muted">Total: <span class="num">{% devtools.profile.total_duration_ms %}</span> ms</div>
            <div class="text-muted">SQL: <span class="num">{% devtools.db.count %}</span> raw / <span class="num">{% devtools.db.unique %}</span> unique / <span class="num">{% devtools.db.duplicate_count %}</span> dup / <span class="num">{% devtools.db.total_ms %}</span> ms</div>
            {% if devtools.external.available %}<div class="text-muted">HTTP: <span class="num">{% devtools.external.count %}</span> calls / <span class="num">{% devtools.external.total_ms %}</span> ms</div>{% else %}<div class="text-muted">HTTP: n/a</div>{% endif %}
            {% if devtools.cache.available %}<div class="text-muted">Cache: <span class="num">{% devtools.cache.hit_rate %}</span>% (hits {% devtools.cache.hits %}, misses {% devtools.cache.misses %}, sets {% devtools.cache.sets %})</div>{% else %}<div class="text-muted">Cache: n/a</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-budgets">
            <span class="info">Budgets</span>
            <div class="text-muted">Total: {% devtools.profile.budget.total_time.status %} (warn {% devtools.flags.budgets.total_time_warn %}, bad {% devtools.flags.budgets.total_time_bad %})</div>
            <div class="text-muted">Slow SQL: {% devtools.profile.budget.slow_sql.status %} (warn {% devtools.flags.budgets.slow_sql_warn %}, bad {% devtools.flags.budgets.slow_sql_bad %})</div>
            <div class="text-muted">Slow HTTP: {% devtools.profile.budget.slow_http.status %} (warn {% devtools.flags.budgets.slow_http_warn %}, bad {% devtools.flags.budgets.slow_http_bad %})</div>
            <div class="text-muted">Duplicates: {% devtools.profile.budget.duplicates.status %}</div>
          </div>

          <div class="mb-2" id="devtools-issues">
            <span class="info">Issues</span>
            {% if devtools.profile.issues_compact %}
            {% foreach devtools.profile.issues_compact as issue %}
            <div class="text-muted"><a href="{% issue.href %}">{% issue.label %}</a> - {% issue.value %} ({% issue.action_label %})</div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-warnings">
            <span class="info">Warnings</span>
            {% if devtools.profile.warnings %}
            {% foreach devtools.profile.warnings as w %}
            <div class="text-muted">{% w %}</div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-errors">
            <span class="info">Errors</span>
            {% if devtools.profile.errors %}
            {% foreach devtools.profile.errors as e %}
            <div class="text-muted">{% e.type %}: {% e.message %}</div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-segments">
            <span class="info">Segments</span>
            {% if devtools.profile.segments %}
            {% foreach devtools.profile.segments as s %}
            <div class="text-muted">{% s.name %}: <span class="num">{% s.ms %}</span> ms (<span class="num">{% s.percent %}</span>%)</div>
            {% endforeach %}
            {% else %}<div class="text-muted">n/a</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-request">
            <span class="info">Request</span>
            <div class="text-muted">Method: {% devtools.request.method %} / Path: {% devtools.request.path %}</div>
            {% if devtools.request.route %}<div class="text-muted">Route: {% devtools.request.route %}</div>{% endif %}
            {% if devtools.request.controller %}<div class="text-muted">Controller: {% devtools.request.controller %}::{% devtools.request.action %}</div>{% endif %}
            <div class="mt-1"><span class="text-muted">GET</span> <span class="num">{% devtools.request.get_raw %}</span></div>
            <div class="mt-1"><span class="text-muted">POST</span> <span class="num">{% devtools.request.post_raw %}</span></div>
            <div class="mt-1">
              <span class="text-muted">Cookies</span>
              {% if devtools.request.cookies %}
              {% foreach devtools.request.cookies as c %}<div>{% c.key %}: {% c.value %}</div>{% endforeach %}
              {% else %}<div class="text-muted">n/a</div>{% endif %}
            </div>
            <div class="mt-1">
              <span class="text-muted">Headers</span>
              {% if devtools.request.headers %}
              {% foreach devtools.request.headers as h %}<div>{% h.key %}: {% h.value %}</div>{% endforeach %}
              {% else %}<div class="text-muted">n/a</div>{% endif %}
            </div>
          </div>

          <div class="mb-2" id="devtools-response">
            <span class="info">Response</span>
            <div class="text-muted">Status: <span class="num">{% devtools.response.status %}</span></div>
            <div class="text-muted">Content-Type: {% devtools.response.content_type %}</div>
          </div>
          {% if devtools.flags.enabled %}{% if devtools.media.id %}
          <div class="mb-2" id="devtools-media">
            <span class="info">Media</span>
            <div class="text-muted">Media ID: {% devtools.media.id %}</div>
            <div class="text-muted">Mime: {% devtools.media.mime %}</div>
            <div class="text-muted">Size: {% devtools.media.size %}</div>
            <div class="text-muted">Mode: {% devtools.media.mode %}</div>
            <div class="text-muted">Disk: {% devtools.media.disk %}</div>
            <div class="text-muted">Storage: {% devtools.media.storage %}</div>
            <div class="text-muted">Read time: {% devtools.media.read_time_ms %} ms</div>
            {% if devtools.media.object_key %}<div class="text-muted">Object key: {% devtools.media.object_key %}</div>{% endif %}
            {% if devtools.media.access_mode %}<div class="text-muted">Access mode: {% devtools.media.access_mode %}</div>{% endif %}
            {% if devtools.media.signature_valid %}<div class="text-muted">Signature valid: {% devtools.media.signature_valid %}</div>{% endif %}
            {% if devtools.media.signature_exp %}<div class="text-muted">Signature exp: {% devtools.media.signature_exp %}</div>{% endif %}
            {% if devtools.media.thumb_generated %}<div class="text-muted">Thumb: {% devtools.media.thumb_generated %}</div>{% endif %}
            {% if devtools.media.thumb_reason %}<div class="text-muted">Thumb reason: {% devtools.media.thumb_reason %}</div>{% endif %}
            {% if devtools.media.thumb_algo %}<div class="text-muted">Thumb algo: {% devtools.media.thumb_algo %}</div>{% endif %}
            {% if devtools.media.s3_requests %}<div class="text-muted">S3 requests: {% devtools.media.s3_requests %}</div>{% endif %}
            {% if devtools.media.s3_time_ms %}<div class="text-muted">S3 time: {% devtools.media.s3_time_ms %} ms</div>{% endif %}
          </div>
          {% endif %}{% endif %}

          <div class="mb-2" id="devtools-sql-slow">
            <span class="info">SQL top slow</span>
            {% if devtools.db.top_slow %}
            {% foreach devtools.db.top_slow as s %}
            <div class="mt-1">
              <span class="num">{% s.duration_ms %}</span> ms
              <div><code class="small text-break">{% s.sql %}</code></div>
            </div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-sql-duplicates">
            <span class="info">SQL duplicates</span>
            {% if devtools.db.duplicates %}
            {% foreach devtools.db.duplicates as d %}
            <div class="mt-1">
              <span class="warn">x{% d.count %}</span> <span class="num">{% d.avg_ms %}</span> ms avg
              <div><code class="small text-break">{% d.sql %}</code></div>
              {% if d.trace %}
              <ol class="mb-0">
                {% foreach d.trace as t %}
                <li><code>{% t.call %}</code> <span class="text-muted">{% t.file %}</span></li>
                {% endforeach %}
              </ol>
              {% endif %}
            </div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-sql-grouped">
            <span class="info">SQL grouped</span>
            {% if devtools.db.grouped %}
            {% foreach devtools.db.grouped as g %}
            <div class="mt-1">
              <span class="num">{% g.count %}</span> calls / <span class="num">{% g.total_ms %}</span> ms
              <div><code class="small text-break">{% g.sql %}</code></div>
            </div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-sql-raw">
            <span class="info">SQL raw</span>
            {% if devtools.db.queries %}
            {% foreach devtools.db.queries as q %}
            <div class="mt-1">
              <span class="num">#{% q.index %}</span> <span class="num">{% q.duration_ms %}</span> ms (params {% q.params %})
              <div><code class="small text-break">{% q.sql %}</code></div>
            </div>
            {% endforeach %}
            {% else %}<div class="text-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-external">
            <span class="info">External</span>
            {% if devtools.external.available %}
            {% foreach devtools.external.top3_slowest_calls as call %}
            <div class="mt-1">
              <span>{% call.method %}</span> <span class="text-muted">{% call.host %}{% call.path %}</span> <span class="num">{% call.total_ms %}</span> ms <span>{% call.status %}</span>
            </div>
            {% endforeach %}
            {% else %}<div class="text-muted">n/a</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-user">
            <span class="info">User</span>
            <div class="text-muted">ID: {% devtools.user.id %}</div>
            <div class="text-muted">Name: {% devtools.user.username %}</div>
            {% if devtools.user.roles %}<div class="text-muted">Roles: {% foreach devtools.user.roles as r %}{% r %} {% endforeach %}</div>{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="devtools-settings" aria-labelledby="devtools-settings-label">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="devtools-settings-label">DevTools Settings</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-2">
        <label class="form-label small">Total time warn</label>
        <input class="form-control form-control-sm" type="text" value="{% devtools.flags.budgets.total_time_warn %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label small">Total time bad</label>
        <input class="form-control form-control-sm" type="text" value="{% devtools.flags.budgets.total_time_bad %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label small">Slow SQL warn</label>
        <input class="form-control form-control-sm" type="text" value="{% devtools.flags.budgets.slow_sql_warn %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label small">Slow SQL bad</label>
        <input class="form-control form-control-sm" type="text" value="{% devtools.flags.budgets.slow_sql_bad %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label small">Slow HTTP warn</label>
        <input class="form-control form-control-sm" type="text" value="{% devtools.flags.budgets.slow_http_warn %}" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label small">Slow HTTP bad</label>
        <input class="form-control form-control-sm" type="text" value="{% devtools.flags.budgets.slow_http_bad %}" readonly>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="devtools-show-secrets" {% if devtools.flags.show_secrets %}checked{% endif %} disabled>
        <label class="form-check-label" for="devtools-show-secrets">Show secrets (admin + dev)</label>
      </div>
      <div class="small text-muted mt-2">Toggle requires DEVTOOLS_SHOW_SECRETS=true and admin in dev/local.</div>
    </div>
  </div>

  <script>
    (function () {
      var root = document.getElementById('devtools-root');
      if (!root) {
        return;
      }

      var copyBtn = root.querySelector('[data-devtools-action="copy"]');
      if (copyBtn) {
        copyBtn.addEventListener('click', function () {
          var dump = root.querySelector('#devtools-terminal-body');
          if (!dump || !navigator.clipboard) {
            return;
          }
          navigator.clipboard.writeText(dump.textContent || '');
        });
      }

      var expandBtn = root.querySelector('[data-devtools-action="expand"]');
      if (expandBtn && window.bootstrap && window.bootstrap.Collapse) {
        expandBtn.addEventListener('click', function () {
          var targets = root.querySelectorAll('.devtools-detail');
          if (!targets.length) {
            return;
          }
          var shouldShow = false;
          targets.forEach(function (el) {
            if (!el.classList.contains('show')) {
              shouldShow = true;
            }
          });
          targets.forEach(function (el) {
            var inst = window.bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
            if (shouldShow) {
              inst.show();
            } else {
              inst.hide();
            }
          });
        });
      }
    })();

    // JS Error Capture (only when DevTools enabled)
    (function () {
      var root = document.getElementById('devtools-root');
      if (!root) {
        return;
      }

      var queue = [];
      var lastSent = 0;
      var maxQueue = 20;

      function sanitizeUrl(url) {
        try {
          var parsed = new URL(url);
          return parsed.protocol + '//' + parsed.host + parsed.pathname;
        } catch (e) {
          return url;
        }
      }

      function sendError(event) {
        var now = Date.now();
        if (now - lastSent < 1000) {
          if (queue.length < maxQueue) {
            queue.push(event);
          }
          return;
        }

        lastSent = now;

        var csrfToken = document.querySelector('meta[name="csrf-token"]');
        var headers = {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        };
        if (csrfToken) {
          headers['X-CSRF-Token'] = csrfToken.getAttribute('content');
        }

        fetch('/__devtools/js-errors/collect', {
          method: 'POST',
          headers: headers,
          credentials: 'same-origin',
          body: JSON.stringify(event)
        }).catch(function (err) {
          // Silent fail
        });

        if (queue.length > 0) {
          var nextEvent = queue.shift();
          setTimeout(function () {
            sendError(nextEvent);
          }, 1000);
        }
      }

      window.addEventListener('error', function (e) {
        var event = {
          type: 'error',
          message: e.message || 'Unknown error',
          source: e.filename || '',
          line: e.lineno || 0,
          column: e.colno || 0,
          stack: e.error && e.error.stack ? e.error.stack : '',
          url: sanitizeUrl(window.location.href),
          userAgent: navigator.userAgent || '',
          happened_at: Date.now()
        };
        sendError(event);
      });

      window.addEventListener('unhandledrejection', function (e) {
        var reason = e.reason;
        var message = 'Unhandled Promise Rejection';
        var stack = '';

        if (reason instanceof Error) {
          message = reason.message || message;
          stack = reason.stack || '';
        } else if (typeof reason === 'string') {
          message = reason;
        }

        var event = {
          type: 'unhandledrejection',
          message: message,
          source: '',
          line: 0,
          column: 0,
          stack: stack,
          url: sanitizeUrl(window.location.href),
          userAgent: navigator.userAgent || '',
          happened_at: Date.now()
        };
        sendError(event);
      });
    })();
  </script>
</div>

<button class="btn btn-sm devtools-show-btn position-fixed bottom-0 end-0 m-2" type="button" data-bs-toggle="collapse" data-bs-target="#devtools-terminal" aria-expanded="false" aria-controls="devtools-terminal">Show DevTools</button>
