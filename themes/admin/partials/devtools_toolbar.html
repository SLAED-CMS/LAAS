<div class="laas-devtools position-fixed bottom-0 start-0 end-0 border-top z-3" id="devtools-root">
  <div class="devtools-terminal collapse show rounded-3 p-2" id="devtools-terminal">
    <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
      <span class="me-auto"> <span class="c-info">SQL:</span> <span class="c-num">{% devtools.profile.terminal.prompt.sql_raw %}/{% devtools.profile.terminal.prompt.sql_unique %}</span> <span class="c-muted">|</span> <span class="c-info">Dup:</span> <span class="c-num">{% devtools.profile.terminal.prompt.sql_dup %}</span> <span class="c-muted">|</span> <span class="c-num">{% devtools.profile.terminal.prompt.sql_ms %}ms</span> <span class="c-info">Time:</span> <span class="c-num">{% devtools.profile.terminal.prompt.total_ms %}ms</span> <span class="c-info">Memory:</span> <span class="c-num">{% devtools.profile.terminal.prompt.memory_mb %}MB</span> <span class="c-info">Cache:</span> <span class="c-num">{% devtools.profile.terminal.prompt.cache_rate %}</span> <span class="c-info">HTTP</span> <span class="c-num">{% devtools.profile.terminal.prompt.http_count %} ({% devtools.profile.terminal.prompt.http_max_ms %}ms)</span> <span>{% devtools.profile.terminal.prompt.method %}:</span> <span class="c-muted">{% devtools.profile.terminal.prompt.path %}</span>{% if devtools.profile.terminal.prompt.post_params %} <span class="c-muted">POST:</span> <span class="c-warn">{% devtools.profile.terminal.prompt.post_params|implode:', ' %}</span>{% endif %} <span class="c-info">Status:</span> <span>{% devtools.profile.terminal.prompt.status %}</span>{% if devtools.profile.terminal.prompt.error_source %} <span class="c-muted">Source:</span> <span class="c-muted">{% devtools.profile.terminal.prompt.error_source %}</span>{% endif %} <span class="c-muted">Req ID:</span> <span class="c-muted">{% devtools.profile.terminal.prompt.request_id %}</span></span>
      <a href="" class="btn devtools-btn" title="Refresh">&#x27F3;</a>
      <button class="btn devtools-btn" type="button" data-devtools-action="copy" title="Copy">&#x29C9;</button>
      <button class="btn devtools-btn" type="button" data-devtools-action="expand" title="Expand all">&#x2912;</button>
      <button class="btn devtools-btn" type="button" data-bs-toggle="collapse" data-bs-target="#devtools-details" aria-controls="devtools-details" title="Toggle Details">&#x2139;</button>
      <button class="btn devtools-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#devtools-settings" aria-controls="devtools-settings" title="Settings">&#x2699;</button>
      <button class="btn devtools-btn" type="button" data-bs-toggle="collapse" data-bs-target="#devtools-terminal" title="Hide">&#x2715;</button>
    </div>
    <div class="terminal-body overflow-auto" id="devtools-terminal-body">
<pre id="devtools-terminal-dump" class="mb-2">
{% if devtools.profile.terminal.warning_tokens %}

<span class="c-warn">&#x26A0; Warnings</span>
{% foreach devtools.profile.terminal.warning_tokens as tok %}<span>{% tok.text %}</span>
{% endforeach %}
{% else %}<span class="c-ok">&#x2713; No warnings</span>{% endif %}{% if devtools.profile.terminal.offenders %}

{% foreach devtools.profile.terminal.offenders as off %}<a class="text-decoration-none" data-bs-toggle="collapse" href="#{% off.id %}" role="button" aria-expanded="false" aria-controls="{% off.id %}"><span class="c-info">{% off.type %}</span> {% if off.is_http %}<span>{% off.detail_method %}</span> <span class="c-muted">{% off.detail_url %}</span>{% else %}<span>{% off.detail_text %}</span>{% endif %} <span class="c-num">{% off.value %}</span></a>
{% endforeach %}{% else %}<span class="c-muted">No offenders</span>{% endif %}
{% if devtools.profile.terminal.timeline_line %}
<span class="c-muted">{% devtools.profile.timeline_line %}</span>{% endif %}
</pre>
    {% foreach devtools.profile.terminal.offenders as off %}
    <div class="collapse devtools-detail c-muted mb-1" id="{% off.id %}">
      {% if off.is_http %}
      <div>HTTP: <span>{% off.detail_method %}</span> <span class="c-muted">{% off.detail_url %}</span> (<span>{% off.detail.status %}</span>, <span class="c-num">{% off.detail.total_ms %}</span> ms)</div>
      {% endif %}
      {% if off.is_sqld %}
      <div>SQLD: {% off.detail.count %} calls (avg <span class="c-num">{% off.detail.avg_ms %}</span> ms)</div>
      <div><code class="text-break">{% off.detail.sql %}</code></div>
      {% if off.detail.trace %}
      <ol class="mb-0">
        {% foreach off.detail.trace as t %}
        <li><code>{% t.call %}</code> <span class="c-muted">{% t.file %}</span></li>
        {% endforeach %}
      </ol>
      {% endif %}
      {% endif %}
      {% if off.is_sql %}
      <div>SQL: <span class="c-num">{% off.detail.total_ms %}</span> ms</div>
      <div><code class="text-break">{% off.detail.sql %}</code></div>
      {% endif %}
    </div>
    {% endforeach %}
      <div id="devtools-details" class="collapse devtools-detail terminal-details" data-devtools-collapse="1" data-devtools-id="details">
        <div class="small">
          <div class="mb-2" id="devtools-js-errors">
            <span class="c-info">JS Errors</span>

            <div id="devtools-js-errors-content">
              {% if devtools.js_errors %}
              <div class="c-muted">
              {% foreach devtools.js_errors as err %}[{% err.time_ago %}] {% if err.is_error %}ERROR{% else %}PROMISE{% endif %}: {% err.message %}
              {% endforeach %}</div>
              {% else %}
              <div class="c-muted">No JS errors</div>
              {% endif %}
            </div>



          <div class="mb-2" id="devtools-overview">
            <span class="c-info">Overview</span>
            <div class="c-muted">Total: <span class="c-num">{% devtools.profile.total_duration_ms %}</span> ms</div>
            <div class="c-muted">SQL: <span class="c-num">{% devtools.db.count %}</span> raw / <span class="c-num">{% devtools.db.unique %}</span> unique / <span class="c-num">{% devtools.db.duplicate_count %}</span> dup / <span class="c-num">{% devtools.db.total_ms %}</span> ms</div>
            {% if devtools.external.available %}<div class="c-muted">HTTP: <span class="c-num">{% devtools.external.count %}</span> calls / <span class="c-num">{% devtools.external.total_ms %}</span> ms</div>{% else %}<div class="c-muted">HTTP: n/a</div>{% endif %}
            {% if devtools.cache.available %}<div class="c-muted">Cache: <span class="c-num">{% devtools.cache.hit_rate %}</span>% (hits {% devtools.cache.hits %}, misses {% devtools.cache.misses %}, sets {% devtools.cache.sets %})</div>{% else %}<div class="c-muted">Cache: n/a</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-budgets">
            <span class="c-info">Budgets</span>
            <div class="c-muted">Total: {% devtools.profile.budget.total_time.status %} (warn {% devtools.flags.budgets.total_time_warn %}, bad {% devtools.flags.budgets.total_time_bad %})</div>
            <div class="c-muted">Slow SQL: {% devtools.profile.budget.slow_sql.status %} (warn {% devtools.flags.budgets.slow_sql_warn %}, bad {% devtools.flags.budgets.slow_sql_bad %})</div>
            <div class="c-muted">Slow HTTP: {% devtools.profile.budget.slow_http.status %} (warn {% devtools.flags.budgets.slow_http_warn %}, bad {% devtools.flags.budgets.slow_http_bad %})</div>
            <div class="c-muted">Duplicates: {% devtools.profile.budget.duplicates.status %}</div>
          </div>

          <div class="mb-2" id="devtools-issues">
            <span class="c-info">Issues</span>
            {% if devtools.profile.issues_compact %}
            {% foreach devtools.profile.issues_compact as issue %}
            <div class="c-muted"><a href="{% issue.href %}">{% issue.label %}</a> - {% issue.value %} ({% issue.action_label %})</div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-warnings">
            <span class="c-info">Warnings</span>
            {% if devtools.profile.warnings %}
            {% foreach devtools.profile.warnings as w %}
            <div class="c-muted">{% w %}</div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-errors">
            <span class="c-info">Errors</span>
            {% if devtools.profile.errors %}
            {% foreach devtools.profile.errors as e %}
            <div class="c-muted">{% e.type %}: {% e.message %}</div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-segments">
            <span class="c-info">Segments</span>
            {% if devtools.profile.segments %}
            {% foreach devtools.profile.segments as s %}
            <div class="c-muted">{% s.name %}: <span class="c-num">{% s.ms %}</span> ms (<span class="c-num">{% s.percent %}</span>%)</div>
            {% endforeach %}
            {% else %}<div class="c-muted">n/a</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-request">
            <span class="c-info">Request</span>
            <div class="c-muted">Method: {% devtools.request.method %} / Path: {% devtools.request.path %}</div>
            {% if devtools.request.route %}<div class="c-muted">Route: {% devtools.request.route %}</div>{% endif %}
            {% if devtools.request.controller %}<div class="c-muted">Controller: {% devtools.request.controller %}::{% devtools.request.action %}</div>{% endif %}
            <div class="mt-1"><span class="c-muted">GET</span> <span class="c-num">{% devtools.request.get_raw %}</span></div>
            <div class="mt-1"><span class="c-muted">POST</span> <span class="c-num">{% devtools.request.post_raw %}</span></div>
            <div class="mt-1">
              <span class="c-muted">Cookies</span>
              {% if devtools.request.cookies %}
              {% foreach devtools.request.cookies as c %}<div>{% c.key %}: {% c.value %}</div>{% endforeach %}
              {% else %}<div class="c-muted">n/a</div>{% endif %}
            </div>
            <div class="mt-1">
              <span class="c-muted">Headers</span>
              {% if devtools.request.headers %}
              {% foreach devtools.request.headers as h %}<div>{% h.key %}: {% h.value %}</div>{% endforeach %}
              {% else %}<div class="c-muted">n/a</div>{% endif %}
            </div>
          </div>

          <div class="mb-2" id="devtools-response">
            <span class="c-info">Response</span>
            <div class="c-muted">Status: <span class="c-num">{% devtools.response.status %}</span></div>
            <div class="c-muted">Content-Type: {% devtools.response.content_type %}</div>
            {% if devtools.response.error_source %}<div class="c-muted">Error source: {% devtools.response.error_source %}</div>{% endif %}
            {% if devtools.response.error_code %}<div class="c-muted">Error code: {% devtools.response.error_code %}</div>{% endif %}
          </div>
          {% if devtools.flags.enabled %}{% if devtools.media.id %}
          <div class="mb-2" id="devtools-media">
            <span class="c-info">Media</span>
            <div class="c-muted">Media ID: {% devtools.media.id %}</div>
            <div class="c-muted">Mime: {% devtools.media.mime %}</div>
            <div class="c-muted">Size: {% devtools.media.size %}</div>
            <div class="c-muted">Mode: {% devtools.media.mode %}</div>
            <div class="c-muted">Disk: {% devtools.media.disk %}</div>
            <div class="c-muted">Storage: {% devtools.media.storage %}</div>
            <div class="c-muted">Read time: {% devtools.media.read_time_ms %} ms</div>
            {% if devtools.media.object_key %}<div class="c-muted">Object key: {% devtools.media.object_key %}</div>{% endif %}
            {% if devtools.media.access_mode %}<div class="c-muted">Access mode: {% devtools.media.access_mode %}</div>{% endif %}
            {% if devtools.media.signature_valid %}<div class="c-muted">Signature valid: {% devtools.media.signature_valid %}</div>{% endif %}
            {% if devtools.media.signature_exp %}<div class="c-muted">Signature exp: {% devtools.media.signature_exp %}</div>{% endif %}
            {% if devtools.media.thumb_generated %}<div class="c-muted">Thumb: {% devtools.media.thumb_generated %}</div>{% endif %}
            {% if devtools.media.thumb_reason %}<div class="c-muted">Thumb reason: {% devtools.media.thumb_reason %}</div>{% endif %}
            {% if devtools.media.thumb_algo %}<div class="c-muted">Thumb algo: {% devtools.media.thumb_algo %}</div>{% endif %}
            {% if devtools.media.s3_requests %}<div class="c-muted">S3 requests: {% devtools.media.s3_requests %}</div>{% endif %}
            {% if devtools.media.s3_time_ms %}<div class="c-muted">S3 time: {% devtools.media.s3_time_ms %} ms</div>{% endif %}
          </div>
          {% endif %}{% endif %}

          <div class="mb-2" id="devtools-sql-slow">
            <span class="c-info">SQL top slow</span>
            {% if devtools.db.top_slow %}
            {% foreach devtools.db.top_slow as s %}
            <div class="mt-1">
              <span class="c-num">{% s.duration_ms %}</span> ms
              <div><code class="text-break">{% s.sql %}</code></div>
            </div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-sql-duplicates">
            <span class="c-info">SQL duplicates</span>
            {% if devtools.db.duplicates %}
            {% foreach devtools.db.duplicates as d %}
            <div class="mt-1">
              <span class="c-warn">x{% d.count %}</span> <span class="c-num">{% d.avg_ms %}</span> ms avg
              <div><code class="text-break">{% d.sql %}</code></div>
              {% if d.trace %}
              <ol class="mb-0">
                {% foreach d.trace as t %}
                <li><code>{% t.call %}</code> <span class="c-muted">{% t.file %}</span></li>
                {% endforeach %}
              </ol>
              {% endif %}
            </div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-sql-grouped">
            <span class="c-info">SQL grouped</span>
            {% if devtools.db.grouped %}
            {% foreach devtools.db.grouped as g %}
            <div class="mt-1">
              <span class="c-num">{% g.count %}</span> calls / <span class="c-num">{% g.total_ms %}</span> ms
              <div><code class="text-break">{% g.sql %}</code></div>
            </div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-sql-raw">
            <span class="c-info">SQL raw</span>
            {% if devtools.db.queries %}
            {% foreach devtools.db.queries as q %}
            <div class="mt-1">
              <span class="c-num">#{% q.index %}</span> <span class="c-num">{% q.duration_ms %}</span> ms (params {% q.params %})
              <div><code class="text-break">{% q.sql %}</code></div>
            </div>
            {% endforeach %}
            {% else %}<div class="c-muted">none</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-external">
            <span class="c-info">External</span>
            {% if devtools.external.available %}
            {% foreach devtools.external.top3_slowest_calls as call %}
            <div class="mt-1">
              <span>{% call.method %}</span> <span class="c-muted">{% call.host %}{% call.path %}</span> <span class="c-num">{% call.total_ms %}</span> ms <span>{% call.status %}</span>
            </div>
            {% endforeach %}
            {% else %}<div class="c-muted">n/a</div>{% endif %}
          </div>

          <div class="mb-2" id="devtools-user">
            <span class="c-info">User</span>
            <div class="c-muted">ID: {% devtools.user.id %}</div>
            <div class="c-muted">Name: {% devtools.user.username %}</div>
            {% if devtools.user.roles %}<div class="c-muted">Roles: {% foreach devtools.user.roles as r %}{% r %} {% endforeach %}</div>{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="devtools-settings" aria-labelledby="devtools-settings-label">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="devtools-settings-label">DevTools Settings</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-2">
        <label class="form-label">Total time warn</label>
        <input class="form-control" type="text" value="{% devtools.flags.budgets.total_time_warn %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label">Total time bad</label>
        <input class="form-control" type="text" value="{% devtools.flags.budgets.total_time_bad %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label">Slow SQL warn</label>
        <input class="form-control" type="text" value="{% devtools.flags.budgets.slow_sql_warn %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label">Slow SQL bad</label>
        <input class="form-control" type="text" value="{% devtools.flags.budgets.slow_sql_bad %}" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label">Slow HTTP warn</label>
        <input class="form-control" type="text" value="{% devtools.flags.budgets.slow_http_warn %}" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">Slow HTTP bad</label>
        <input class="form-control" type="text" value="{% devtools.flags.budgets.slow_http_bad %}" readonly>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="devtools-show-secrets" {% if devtools.flags.show_secrets %}checked{% endif %} disabled>
        <label class="form-check-label" for="devtools-show-secrets">Show secrets (admin + dev)</label>
      </div>
      <div class="c-muted mt-2">Toggle requires DEVTOOLS_SHOW_SECRETS=true and admin in dev/local.</div>
    </div>
  </div>

</div>

<button class="btn devtools-show-btn position-fixed bottom-0 end-0 m-2" type="button" data-bs-toggle="collapse" data-bs-target="#devtools-terminal" aria-expanded="false" aria-controls="devtools-terminal">Show DevTools</button>
