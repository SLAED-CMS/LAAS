sequenceDiagram
    %% LAAS CMS v3.0.0 - HTTP Request Lifecycle
    %% Flow: Bootstrap -> Middleware -> Routing -> Business Logic -> RenderAdapter -> Response
    %% Performance: Cold 80-120ms, Warm 15-25ms (cache hit 99%)
    %% Security: Session timeout, 2FA/TOTP, password reset, SSRF protection
    %% Frontend: Content negotiation (Accept header, ?format), AssetManager, UI Tokens
    %% Version: v3.0.0 (2026-01-12)

    participant Browser
    participant Nginx
    participant PHP as PHP-FPM
    participant Index as public/index.php
    participant Dotenv
    participant Kernel
    participant MW as Middleware Pipeline
    participant Router
    participant Controller
    participant Repo as Repository
    participant DB as MariaDB/MySQL
    participant View
    participant RenderAdapter
    participant Engine as TemplateEngine
    participant Theme as ThemeManager
    participant AssetMgr as AssetManager

    Browser->>Nginx: GET /pages/welcome (Accept: text/html)
    Nginx->>PHP: FastCGI Request
    PHP->>Index: Execute index.php

    Note over Index,Dotenv: Bootstrap Phase
    Index->>Dotenv: Load .env file
    Dotenv-->>Index: $_ENV populated
    Index->>Kernel: new Kernel($rootPath)

    Note over Kernel,MW: Middleware Pipeline (Order matters!)
    Kernel->>MW: ErrorHandlerMiddleware
    MW->>MW: SessionMiddleware (start session)
    MW->>MW: CSRFMiddleware (skip for GET)
    MW->>MW: RateLimitMiddleware (check limits)
    MW->>MW: SecurityHeadersMiddleware (CSP, etc)
    MW->>MW: AuthMiddleware (load user if session exists)
    MW->>MW: RBACMiddleware (check permissions for /admin)

    Note over MW,Router: Routing Phase
    MW->>Router: Dispatch request
    Router->>Router: Match route: GET /pages/{slug}
    Router->>Controller: PagesController::show($slug)

    Note over Controller,DB: Business Logic Phase
    Controller->>Repo: PagesRepository::findBySlug('welcome')
    Repo->>DB: SELECT * FROM pages WHERE slug = ? AND status = 1
    DB-->>Repo: Row data (array)
    Repo-->>Controller: $page array or null

    alt Page not found
        Controller-->>Kernel: throw NotFoundException()
        Kernel-->>Browser: HTTP 404
    else Page found
        Note over Controller,AssetMgr: View Rendering Phase (Content Negotiation)
        Controller->>View: render('pages/show.html', ['page' => $page])
        View->>RenderAdapter: Detect format (Accept header or ?format)
        RenderAdapter->>RenderAdapter: Check Accept: text/html or ?format=html

        alt JSON requested (Accept: application/json or ?format=json)
            RenderAdapter->>RenderAdapter: Use JsonRenderAdapter
            RenderAdapter-->>Controller: JSON envelope + Problem Details on error
        else HTML requested (default)
            RenderAdapter->>Theme: Resolve theme path (default or admin)
            Theme-->>RenderAdapter: themes/default/pages/show.html
            RenderAdapter->>AssetMgr: Build asset tags (CSS/JS)
            AssetMgr-->>RenderAdapter: <link> and <script> tags with cache-busting
            RenderAdapter->>Engine: compile($template, $data + $assets)

        Note over Engine: Template Compilation
        Engine->>Engine: Check cache (storage/cache/templates/)
        alt Cache miss
            Engine->>Engine: Compile {% %} syntax to PHP
            Engine->>Engine: Auto-escape variables (XSS protection)
            Engine->>Engine: Save to cache
        end
            Engine-->>RenderAdapter: Compiled HTML
            RenderAdapter-->>View: Final HTML with assets
        end

        View-->>Controller: Response (HTML or JSON)
        Controller->>Controller: new Response($content, 200, $headers)
        Controller-->>Kernel: Response object

        Note over Kernel,Browser: Response Phase
        Kernel->>Kernel: Apply security headers
        Kernel->>Kernel: Set cookies (session, csrf)
        Kernel-->>PHP: Response->send()
        PHP-->>Nginx: HTTP Response
        Nginx-->>Browser: HTML + Headers
    end

    Note over Browser,Nginx: HTMX Support
    Note over View,Engine: If HX-Request header present:<br/>Return only content block (no layout)
