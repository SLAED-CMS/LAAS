graph LR
    %% LAAS CMS v3.0.0 - Middleware Pipeline
    %% 7 middlewares in strict order (Session before Auth, Auth before RBAC)
    %% Security: CSRF, Rate Limiting, CSP, HSTS, RBAC, API Auth, Session Timeout, SSRF Protection
    %% Performance: Total overhead 5-10ms
    %% Version: v4.0.0 (2026-01-16)

    Request["HTTP Request<br/>(from Nginx)"] --> ErrorHandler

    subgraph Pipeline["Middleware Pipeline (Ordered)"]
        ErrorHandler["1. ErrorHandlerMiddleware<br/>Catch all exceptions"]
        HttpLimits["2. HttpLimitsMiddleware<br/>Request limits (v3.20.0)"]
        Session["3. SessionMiddleware<br/>Start PHP session + check timeout (v3.0.0)"]
        CSRF["4. CSRFMiddleware<br/>Validate token (POST/PUT/DELETE)"]
        RateLimit["5. RateLimitMiddleware<br/>Check rate limits (login, API)"]
        Security["6. SecurityHeadersMiddleware<br/>CSP, X-Frame-Options, etc"]
        Auth["7. AuthMiddleware<br/>Load authenticated user"]
        RBAC["8. RBACMiddleware<br/>Check permissions (/admin)"]

        ErrorHandler --> HttpLimits
        HttpLimits --> Session
        Session --> CSRF
        CSRF --> RateLimit
        RateLimit --> Security
        Security --> Auth
        Auth --> RBAC
    end

    RBAC --> Router["Router<br/>Dispatch to Controller"]
    Router --> Response["HTTP Response<br/>(to Browser)"]

    style ErrorHandler fill:#ff6b6b
    style HttpLimits fill:#ff6b6b
    style Session fill:#4ecdc4
    style CSRF fill:#ffe66d
    style RateLimit fill:#ff6b6b
    style Security fill:#95e1d3
    style Auth fill:#a8e6cf
    style RBAC fill:#ffd3b6
    style Router fill:#c7ceea

    %% Notes
    Note1["Note: Each middleware can:<br/>- Modify request<br/>- Short-circuit (return early)<br/>- Pass to next middleware"]
    Note2["Critical: Order matters!<br/>Session must come before Auth<br/>Auth must come before RBAC"]
